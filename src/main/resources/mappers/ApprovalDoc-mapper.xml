<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kedu.project.dao.ApprovalDocDAO">

    <!-- ✅ 결재선 INSERT -->
    <insert id="insertApprovalLine" parameterType="map">
        INSERT INTO approval_line (
            seq,
            approval_id,
            approvalNumber,
            approval_userid,
            approver_id,
            approver_order,
            approver_status,
            status,
            writeDate
        ) VALUES (
            approval_line_seq.NEXTVAL,
            #{approvalId},
            #{approvalNumber},     <!-- ✅ 수정: approvalNumber 넘겨받아 저장 -->
            #{approvalUserId},
            #{approverId},
            #{orderNo},
            'WAITING',             <!-- 개별 결재자 상태 -->
            'WAITING',             <!-- 결재라인 상태 -->
            SYSTIMESTAMP
        )
    </insert>

    <!-- ✅ 결재선 조회 -->
    <select id="selectApprovalLine" parameterType="string" resultType="map">
        SELECT
            al.seq,
            al.approval_id AS approvalId,
            al.approver_id AS id,
            m.name AS name,
            m.rank_code AS rank_code,
            al.approver_status AS status
        FROM approval_line al
        JOIN member m ON al.approver_id = m.id
        WHERE al.approval_id = #{approvalId}
        ORDER BY al.approver_order
    </select>

    <!-- ✅ 결재자 상태 변경 -->
    <update id="updateStatus" parameterType="map">
        UPDATE approval_line
        SET approver_status = #{status}
        WHERE approval_id = #{approvalId}
        AND approver_id = #{approverId}
    </update>

</mapper>
