<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kedu.project.dao.ApprovalDocDAO">
<insert id="insertApprovalLine" parameterType="map">
INSERT INTO approval_line (
    seq,
    approval_id,
    approvalNumber,
    approval_userid,
    approver_id,
    approver_order,
    approver_status,
    status,
    writeDate
) VALUES (
    approval_line_seq.NEXTVAL,
    #{approvalId},
    #{approvalNumber},
    #{approvalUserId},
    #{approverId},

    <choose>
        <when test="orderNo != null">
            #{orderNo}
        </when>
        <otherwise>
            NULL
        </otherwise>
    </choose>,

    #{status},       <!-- ✅ approver_status -->
    #{docStatus},    <!-- ✅ 문서 상태는 WAITING 유지 -->
    SYSTIMESTAMP
)
</insert>




    <!-- ✅ 결재선 조회 -->
<select id="selectApprovalLine" parameterType="string" resultType="map">
    SELECT
        al.seq,
        al.approval_id AS approvalId,
        al.approver_id AS id,
        m.name AS name,
        m.rank_code AS rank_code,
        al.approver_status AS STATUS,
        CASE 
            WHEN al.approver_order IS NULL THEN 1 ELSE 0 
        END AS referenceFlag
    FROM approval_line al
    JOIN member m ON al.approver_id = m.id
    WHERE al.approval_id = #{approvalId}
    ORDER BY referenceFlag, al.approver_order
</select>
    
    <!-- ✅ 휴가 seq -> approval_id 조회 -->
    <select id="getApprovalIdBySeq" resultType="string">
        SELECT approval_id
        FROM leave_request
        WHERE seq = #{seq}
    </select>


<!--  현재 결재 담당자 -->
<select id="getCurrentApprover" resultType="string">
    SELECT approver_id
    FROM (
        SELECT approver_id
        FROM approval_line
        WHERE approval_id = #{approvalId}
          AND approver_status = 'WAITING'
        ORDER BY approver_order
    )
    WHERE ROWNUM = 1
</select>

<!--  다음 결재자 -->
<select id="getNextApprover" parameterType="map" resultType="string">
    SELECT approver_id
    FROM (
        SELECT approver_id, approver_order
        FROM approval_line
        WHERE approval_id = #{approvalId}
          AND approver_status = 'WAITING'
        ORDER BY approver_order
    )
    WHERE approver_order >
        (SELECT approver_order FROM approval_line
         WHERE approval_id = #{approvalId}
           AND approver_id = #{approverId})
      AND ROWNUM = 1
</select>

<select id="selectReferenceList" parameterType="map" resultType="com.kedu.project.dto.MemberDTO">
    SELECT id, name, dept_code, rank_code
    FROM member
    WHERE dept_code = #{deptCode}
      AND id != #{memberId}
</select>

<update id="updateRejectReason" parameterType="map">
    UPDATE leave_request
    SET reject_reason = #{reason},
        reject_time = SYSTIMESTAMP
    WHERE seq = #{seq}
</update>



<!--  상급자 출력 -->
<select id="selectApproverCandidates" parameterType="map" resultType="com.kedu.project.dto.MemberDTO">
SELECT 
   id,
   name,
   dept_code,
   rank_code
FROM member
WHERE id != #{memberId}
  AND (
        rank_code = '사장'                      
     OR (dept_code = #{deptCode}                  
         AND (
              (#{rankCode} = '사원' AND rank_code IN ('주임','대리','과장','차장','부장','사장'))
           OR (#{rankCode} = '주임' AND rank_code IN ('대리','과장','차장','부장','사장'))
           OR (#{rankCode} = '대리' AND rank_code IN ('과장','차장','부장','사장'))
           OR (#{rankCode} = '과장' AND rank_code IN ('차장','부장','사장'))
           OR (#{rankCode} = '차장' AND rank_code IN ('부장','사장'))
           OR (#{rankCode} = '부장' AND rank_code = '사장')
           OR (#{rankCode} = '사장')
        )
      )
  )
ORDER BY 
  CASE rank_code
    WHEN '사원' THEN 1
    WHEN '주임' THEN 2
    WHEN '대리' THEN 3
    WHEN '과장' THEN 4
    WHEN '차장' THEN 5
    WHEN '부장' THEN 6
    WHEN '임원' THEN 7
    WHEN '사장' THEN 8
  END
</select>

    
      <update id="updateApproverStatus" parameterType="map">
        UPDATE approval_line
        SET approver_status = #{status}, writeDate = SYSTIMESTAMP
        WHERE approval_id = #{approvalId}
        AND approver_id = #{approverId}
    </update>

</mapper>
